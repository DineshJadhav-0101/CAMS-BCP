name: Update Backend URL

on:
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  update-url:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Azure CLI
        uses: azure/setup-cli@v1

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run update script
        run: |
          chmod +x ./update_backend_urls.sh
          ./update_backend_urls.sh

          #!/bin/bash

# Variables
RESOURCE_GROUP="IPRU-INC-PROD-APIM-RG"
APIM_NAME="API Management services"
API_NAME="WebsiteAPI-CamsProxy"
PROD_URL="https://eiscp2.camsonline.com"
DR_URL="https://eiscp3.camsonline.com"

# Function to update backend URL for a specific operation
update_backend_url() {
    local operation_id=$1
    echo "Updating operation: $operation_id"
    az apim api operation update \
        --resource-group $RESOURCE_GROUP \
        --service-name $APIM_NAME \
        --api-id $API_NAME \
        --operation-id $operation_id \
        --set "request.backendServiceUrl=$DR_URL"
}

# Get all operations for the API
operations=$(az apim api operation list --resource-group $RESOURCE_GROUP --service-name $APIM_NAME --api-id $API_NAME --query "[].{id: operationId}" -o tsv)

# Loop through each operation and update the backend URL
for operation_id in $operations; do
    # Check if the current backend URL is the production URL
    current_url=$(az apim api operation show --resource-group $RESOURCE_GROUP --service-name $APIM_NAME --api-id $API_NAME --operation-id $operation_id --query "request.backendServiceUrl" -o tsv)
    
    if [[ "$current_url" == "$PROD_URL" ]]; then
        update_backend_url $operation_id
    else
        echo "Operation $operation_id does not use the production URL. Skipping."
    fi
done

echo "All applicable operations updated to use DR backend URL."
